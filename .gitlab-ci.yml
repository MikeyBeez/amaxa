stages:
  - unit_test
  - package
  - package_test
  - deploy

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache"

test_unit:
  image: python:3.6-slim
  stage: unit_test
  cache:
    paths:
      - .cache/pip
      - venv/
  before_script:
    - python -V
    - python -m venv venv
    - source venv/bin/activate
    - pip install --upgrade pip
    - pip install -r requirements.txt -r testing-requirements.txt
  script:
    - pytest --junitxml=test-reports/junit.xml --cov-config pytest.ini --cov=amaxa amaxa/test
    - codecov
  artifacts:
    reports:
      junit: test-reports/junit.xml
  only: 
    - branches

test_org:
  image: circleci/python:3.6.4-node
  stage: unit_test
  cache:
    paths:
      - .cache/pip
      - venv/
      - node_modules/
  before_script:
    - python -V
    - python -m venv venv
    - source venv/bin/activate
    - pip install --upgrade pip
    - pip install -r requirements.txt -r testing-requirements.txt
    - if [ ! -d node_modules/sfdx-cli ]; then
          export SFDX_AUTOUPDATE_DISABLE=true;
          export SFDX_USE_GENERIC_UNIX_KEYCHAIN=true;
          export SFDX_DOMAIN_RETRY=300;
          npm install sfdx-cli;
      fi;
  script:
    - sudo ln -s $(pwd)/node_modules/sfdx-cli/bin/run /usr/local/bin/sfdx;
    - sfdx --version
    - openssl aes-256-cbc -k $KEY -in assets/server.key.enc -out assets/server.key -d -md sha256
    - sfdx force:auth:jwt:grant --clientid $CONSUMERKEY --jwtkeyfile assets/server.key --username $USERNAME --setdefaultdevhubusername -a DevHub
    - source assets/scripts/prep-scratch-org.sh
    - sfdx force:apex:execute -f assets/scripts/UpdateUser.apex -u scratch
    - pytest --junitxml=test-reports/junit.xml --cov-config pytest.ini --cov=amaxa amaxa/test_org
    - codecov
  after_script:
    - sfdx force:org:delete -u scratch -p
    - rm assets/server.key
  artifacts:
    reports:
      junit: test-reports/junit.xml
  only: 
    - branches

package:
  image: python:3.6-slim
  stage: package
  cache:
    paths:
      - .cache/pip
      - venv/
  variables:
    TWINE_USERNAME: $TEST_PYPI_USERNAME
    TWINE_PASSWORD: $TEST_PYPI_PASSWORD
  before_script:
    - python -V
    - python -m venv venv
    - source venv/bin/activate
    - pip install --upgrade pip
    - pip install -r requirements.txt twine
  script:
    - python setup.py sdist bdist_wheel
    - twine upload --repository-url https://test.pypi.org/legacy/ dist/*
  only:
    - branches

package_test:
  image: circleci/python:3.6.4-node
  stage: package_test
  cache:
    paths:
      - .cache/pip
      - venv/
      - node_modules/
    policy: pull
  before_script:
    - python -V
    - python -m venv venv
    - source venv/bin/activate
    - pip install --upgrade pip
    - pip install -r requirements.txt
    - pip install --index-url https://test.pypi.org/simple/ amaxa==$CI_PIPELINE_ID
    - amaxa --help
    - if [ ! -d node_modules/sfdx-cli ]; then
          export SFDX_AUTOUPDATE_DISABLE=true;
          export SFDX_USE_GENERIC_UNIX_KEYCHAIN=true;
          export SFDX_DOMAIN_RETRY=300;
          npm install sfdx-cli;
      fi;
  script:
    - sudo ln -s $(pwd)/node_modules/sfdx-cli/bin/run /usr/local/bin/sfdx;
    - sfdx --version
    - openssl aes-256-cbc -k $KEY -in assets/server.key.enc -out assets/server.key -d -md sha256
    - sfdx force:auth:jwt:grant --clientid $CONSUMERKEY --jwtkeyfile assets/server.key --username $USERNAME --setdefaultdevhubusername -a DevHub
    - sfdx force:org:create -v DevHub -s -f assets/project-scratch-def.json -a scratch
    - sfdx force:apex:execute -f assets/scripts/UpdateUser.apex -u scratch
    - source assets/scripts/get-auth-params.sh
    - cd assets/test_data_csv
    - amaxa --load --credentials credentials-env.yml test.yml
    - amaxa --credentials credentials-env.yml test.yml
  after_script:
    - sfdx force:org:delete -u scratch -p
    - rm assets/server.key
  only:
    - branches

deploy_package:
  stage: deploy
  when: manual
  image: python:3.6-slim
  variables:
    TWINE_USERNAME: $PYPI_PRODUCTION_USERNAME
    TWINE_PASSWORD: $PYPI_PRODUCTION_PASSWORD
  before_script:
    - python -V
    - python -m venv venv
    - source venv/bin/activate
    - pip install --upgrade pip
    - pip install -r requirements.txt twine
  script:
    - python setup.py bdist_wheel
    - twine upload dist/*
  only:
    - tags